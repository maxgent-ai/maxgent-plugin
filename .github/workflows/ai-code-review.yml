---
name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  codex:
    # åªåœ¨åŒä»“åº“ PR æ—¶è¿è¡Œï¼ˆæ’é™¤ fork PRï¼Œfork æ— æ³•è®¿é—® secretsï¼‰
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      review: ${{ steps.codex.outputs.final-message }}

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Run Codex Review
        id: codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          sandbox: workspace-write
          prompt: |
            å®¡æŸ¥è¿™ä¸ª PR å¼•å…¥çš„å˜æ›´ã€‚è¯·ç”¨ä¸­æ–‡è¾“å‡ºã€‚

            Base branch: origin/${{ github.event.pull_request.base.ref }}
            Head commit: ${{ github.event.pull_request.head.sha }}

            ä½¿ç”¨ `git diff origin/${{ github.event.pull_request.base.ref }}...HEAD` æŸ¥çœ‹å˜æ›´ã€‚

            é‡ç‚¹å…³æ³¨ï¼š
            1. æ½œåœ¨çš„ bug æˆ–é€»è¾‘é”™è¯¯
            2. å®‰å…¨æ¼æ´
            3. æ€§èƒ½é—®é¢˜
            4. ä»£ç æ˜¯å¦ç®€æ´ï¼ˆæœ‰æ— å†—ä½™ä»£ç ã€è¿‡åº¦æŠ½è±¡ï¼‰
            5. è®¾è®¡æ˜¯å¦åˆç†ï¼ˆæ¶æ„ã€æ¨¡å—åˆ’åˆ†ã€æ¥å£è®¾è®¡ï¼‰
            6. æ˜¯å¦å½±å“å…¶ä»–æ¨¡å—ï¼ˆæ£€æŸ¥æ˜¯å¦æ”¹å˜äº†ç°æœ‰æ¨¡å—çš„è¡Œä¸ºã€æ¥å£æˆ–ä¾èµ–ï¼‰
            7. å‘åå…¼å®¹æ€§ï¼ˆAPI å˜æ›´æ˜¯å¦ä¼šç ´åç°æœ‰è°ƒç”¨æ–¹ï¼‰
            8. æµ‹è¯•è¦†ç›–ï¼ˆæ–°å¢ä»£ç æ˜¯å¦æœ‰å¯¹åº”æµ‹è¯•ã€è¾¹ç•Œæƒ…å†µæ˜¯å¦è¦†ç›–ï¼‰

            è¦æ±‚ï¼š
            - ç®€æ´ã€å¯æ“ä½œ
            - è·³è¿‡ä»£ç é£æ ¼ç»†èŠ‚ï¼ˆæ ¼å¼ã€å‘½åç­‰ï¼‰
            - ä½¿ç”¨ markdown æ ¼å¼
            - å…¨éƒ¨ç”¨ä¸­æ–‡è¾“å‡º

  post_feedback:
    needs: codex
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Submit Review
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          REVIEW_CONTENT: ${{ needs.codex.outputs.review }}
        with:
          script: |
            const reviewContent = process.env.REVIEW_CONTENT || 'å®¡æŸ¥ç»“æœä¸ºç©º';
            const body = `## ğŸ¤– Codex ä»£ç å®¡æŸ¥

            ${reviewContent}

            ---
            <sub>ç”± [OpenAI Codex](https://openai.com/codex/) ç”Ÿæˆ | [æŸ¥çœ‹ workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body,
              event: 'REQUEST_CHANGES'
            });
