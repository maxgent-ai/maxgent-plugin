---
name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  codex:
    # Only run on same-repo PRs (skip fork PRs â€” forks cannot access secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      review: ${{ steps.codex.outputs.final-message }}

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Run Codex Review
        id: codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          sandbox: workspace-write
          prompt: |
            Review the changes introduced by this PR. Output in Chinese.

            Base branch: origin/${{ github.event.pull_request.base.ref }}
            Head commit: ${{ github.event.pull_request.head.sha }}

            Use `git diff origin/${{ github.event.pull_request.base.ref }}...HEAD` to view the changes.

            Focus on:
            1. Potential bugs or logic errors
            2. Security vulnerabilities
            3. Performance issues
            4. Code conciseness (redundant code, over-abstraction)
            5. Design quality (architecture, module boundaries, interface design)
            6. Impact on other modules (behavioral, interface, or dependency changes)
            7. Backward compatibility (whether API changes break existing callers)
            8. Test coverage (tests for new code, edge case coverage)

            Requirements:
            - Concise and actionable
            - Skip code style details (formatting, naming, etc.)
            - Use markdown format
            - Output entirely in Chinese

  post_feedback:
    needs: codex
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Submit Review
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          REVIEW_CONTENT: ${{ needs.codex.outputs.review }}
        with:
          script: |
            const reviewContent = process.env.REVIEW_CONTENT || 'Review result is empty';
            const body = `## ðŸ¤– Codex Code Review

            ${reviewContent}

            ---
            <sub>Generated by [OpenAI Codex](https://openai.com/codex/) | [View workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body,
              event: 'REQUEST_CHANGES'
            });
